@model Inventory.ViewModels.Purchase.PurchaseIndexViewModel

@{
    Layout = "_Layout";
}

<div class="container mt-5">
    <div class="row">

        <div class="col-6">
            
            <div class="form-group shadow p-3 ">
                <label class="font-weight-bold" asp-for="SupplierId"></label>
                @Html.DropDownListFor(a => a.SupplierId, new SelectList(Model.Suppliers, "Id", "Name"), new { @class = "form-control", id = "SupplierId" })
                <span asp-validation-for="SupplierId" class="text-danger"></span>
                <a class="btn mt-2 btn-info text-white btn-sm small" id="change" hidden> change </a>
            </div>

            <form class="shadow rounded border-primary border-left  text-dark  p-4" method="post" asp-controller="Purchase" asp-action="Create">
                <div class="form-group">
                    <label class="font-weight-bold" asp-for="ItemId"></label>
                    @Html.DropDownListFor(a => a.ItemId, new SelectList(Model.Items, "Id", "Name"), new { @class = "form-control", id = "item_id" })
                </div>

                <div class="form-group">
                    <label class="font-weight-bold col-form-label"> Rate: </label>
                    <input id="rate" class="form-control" />
                </div>

                <div class="form-group">
                    <label class="font-weight-bold col-form-label"> Quantity: </label>
                    <input id="qty" value="1" class="form-control" placeholder="Input quantity" />
                </div>


                <button id="button" type="submit" class="btn btn-primary"><i class="fas fa-plus"></i></button>
            </form>
        </div>

        <div class="col-6">
            <div class="table-responsive" style="max-height:300px; overflow-y:scroll;">
                <table class="table detail-table">
                    <thead class="shadow ">
                        <tr>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th>Rate</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>

                    <tbody>
                    </tbody>

                </table>
            </div>

            <form method="POST">
                <ul class="list-group mt-3">

                    <li class="list-group-item bg active">Sale Detail</li>

                    <li class="list-group-item text-right ">
                        Total:-
                        <input id="totalAmt" readonly />
                    </li>

                    <li class="list-group-item text-right ">
                        V.A.T:-
                        <input id="vat" readonly />
                    </li>

                    <li class="list-group-item text-right ">

                        Discount:-
                        <input  id="discount" value="20" />
                        </li>


                    <li class="list-group-item text-right text-danger ">
                        Grand Total: -
                        <input id="grand" readonly />
                    </li>

                </ul>



                <button id="btnSave" type="submit" class="btn btn-block btn-success"><i class="fas fa-save"></i></button>
            </form>
            <li class="list-group-item text-right text-info ">
                Remarks
                <textarea class="form-control" id="remarks" ></textarea>
                <button class="btn mt-2 btn-outline-info btn-sm" id="btnRemark"> Auto Add Remarks </button>
            </li>
        </div>
    </div>



</div>

@section scripts{ 

<script>
    //Create Purchase Jquery

    $(document).ready(function () {

        $('#SupplierId').on('change', function (e) {

            $('#SupplierId').attr('disabled', true);
            $('#change').attr('hidden', false);


        });

        $("#change").on('click',
            function(e) {
                $('#SupplierId').attr('disabled', false);
                $('#change').attr('hidden', true);

            });

        $("#btnRemark").on('click',
            function(e) {
                $('#remarks').append("Thank you For your Purchase! Remember Once items are taken, it will not be refunded.");
                $('#btnRemark').attr('disabled', true);
            });


        function checkDuplicate(itemId) {
            event.preventDefault();
            let result = true;
            $('table tr').each(function() {

                row = $(this).closest('tr');
                find_id = parseInt(row.find('td').eq(0).text());
                console.log("find id :- " + find_id);

                if (itemId == find_id) {
                    alert("You have entered the same Item!");
                    result = false;
                }

            });
            return result;

        }

        $('#button').click(function (e) {
            e.preventDefault();

            itemId = $('#item_id').val();
            itemName = $("#item_id option:selected").text();
            rate = $('#rate').val();
            qty = $('#qty').val();
            amt = rate * qty;


            if (checkDuplicate(itemId)) {
                $('table tbody').append(
                    `<tr>
                        <td id="item-id" hidden> ${itemId} </td > 
                        <td id="item-name"> ${itemName} </td>
                        <td id="qty-list">
                            <i id="minus" class="fas mr-2 fa-minus-circle"></i> <span id="q"> ${qty} </span> <i id="plus" class="fas ml-2 fa-plus-circle"></i>
                        </td>
                        <td id="rate-list"> ${rate} </td >
                        <td id="amt"> ${amt} </td>
                        <td>
                            <button id="removeButton" class="btn btn-danger"> <i class="fas fa-trash"></i> </button>
                        </td>
                    </tr >`
                );

            }

            calculateTotal();

        });


        $('body').delegate("#minus",
            "click",
            function(e) {

                e.preventDefault();

                row = $(this).closest("tr");
                rate = row.find("td").eq(3).text();
                qty = parseInt(row.find("td").eq(2).text());
                qty--;

                if (qty >= 0) {

                    amt = rate * qty;


                    parseInt(row.find("td").eq(4).text(amt));
                    calculateTotal();


                    var counter = parseInt(row.find("#qty-list").text());
                    counter--;
                    row.find("#q").text(counter);

                } else {

                    row.find("#minus").attr("disabled", true);

                }


            });


        $('body').delegate("#plus",
            "click",
            function(e) {
                e.preventDefault();

                row = $(this).closest("tr");

                rate = row.find("td").eq(3).text();
                qty = row.find("td").eq(2).text();
                qty++;
                amt = rate * qty;


                parseInt(row.find("td").eq(4).text(amt));
                calculateTotal();


                var counter = parseInt(row.find("#qty-list").text());
                counter++;
                row.find("#q").text(counter);

            });


        $('#item_id').trigger('change');


        function calculateTotal() {

            var total = 0;
            $('table tr').each(function () {
                var value = parseInt($('td', this).eq(4).text());
                if (!isNaN(value)) {
                    total += value;
                }
                var vat = total * (13 / 100);
                var discount = $('#discount').val();
                var grand = (parseInt(total, 10) + parseInt(vat, 10)) - parseInt(discount, 10);
                $('#grand').val(grand);
                $('#totalAmt').val(total);
                $('#vat').val(vat);
            });
        }

        $('body').delegate('#removeButton', 'click', function (e) {
            e.preventDefault();
            $(this).closest('tr').remove();
            calculateTotal();
        });

        function checkIfEmpty() {
            var tbody = $(".table>tbody>tr");

            if (tbody.length > 0) {
                return true;
            }
            else {
                alert("Your Purchase List is Empty...");
                return false;
            }
        }

        $("#btnSave").click(function (e) {
            e.preventDefault();

            checkIfEmpty();

            var url = `/Purchase/Create`;

            var data = {
                SupplierId: $('#SupplierId').val(),
                ItemId: $('#item_id').val(),
                Total: $('#totalAmt').val(),
                GrandTotal: $('#grand').val(),
                Discount: $('#discount').val(),
                Vat: $('#vat').val(),
                Remarks: $('#remarks').val(),
                PurchaseDetails: [],

            }

            $('table>tbody>tr').each(function () {
                console.log('each function triggered...');

                data.PurchaseDetails.push({
                    ItemId: $(this).find('#item-id').text(),
                    SupId: $(this).find('#SupId').val(),
                    Qty: $(this).find('#q').text(),
                    Rate: $(this).find('#rate-list').text(),
                    Amount: $(this).find('#amt').text(),
                });
            });


            $.ajax({
                url: url,
                data: data,
                type: 'POST',
                dataType: 'json',
                success: function (data, status) {
                    console.log(data);
                    alert("Purchase Saved Successfully!")
                    window.location.href = `/Purchase/Index`;

                }
            });

        });


    });
</script>

}